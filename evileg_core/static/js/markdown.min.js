var allEditors={},selectionRange=null;jQuery.fn.extend({insertAtCaret(a){return this.each(function(b){if(document.selection)this.focus(),document.selection.createRange().text=a,this.focus();else if(this.selectionStart||"0"==this.selectionStart){b=this.selectionStart;var c=this.selectionEnd,d=this.scrollTop;this.value=this.value.substring(0,b)+a+this.value.substring(c,this.value.length);this.focus();this.selectionStart=b+a.length;this.selectionEnd=b+a.length;this.scrollTop=d}else this.value+=a,this.focus()})}});
var EMarkdownEditor=function(a,b){b=void 0===b?"":b;this.id=a;this.textarea=jQuery("#"+a);this.tabPreviewLink=jQuery("#"+a+"_tab_preview_link");this.tabPreviewLink.bind("shown.bs.tab",{widgetId:a},EMarkdownEditor.updatePreview);this.linkDialog=jQuery("#"+a+"_add_link_dialog");this.addLinkBtn=jQuery("#"+a+"_add_link_btn");this.addLinkBtn.bind("click",{dialog:this.linkDialog},EMarkdownEditor.showDialog);this.insertLinkBtn=jQuery("#"+a+"_insert_link_btn");this.insertLinkBtn.bind("click",{widgetId:a},
EMarkdownEditor.insertLink);this.linkText=jQuery("#"+a+"_link_text");this.linkUrl=jQuery("#"+a+"_link_url");this.codeDialog=jQuery("#"+a+"_code_dialog");this.addCodeBtn=jQuery("#"+a+"_add_code_btn");this.addCodeBtn.bind("click",{dialog:this.codeDialog},EMarkdownEditor.showDialog);this.insertCodeBtn=jQuery("#"+a+"_insert_code_btn");this.insertCodeBtn.bind("click",{widgetId:a},EMarkdownEditor.insertCode);this.selectCode=jQuery("#"+a+"_select_code");this.codeInput=jQuery("#"+a+"_code_input");this.uploadLink=
b;this.addImageBtn=jQuery("#"+a+"_add_image_btn");this.addImageBtn.bind("click",{widgetId:a},EMarkdownEditor.showUploadDialog);this.addCutBtn=jQuery("#"+a+"_add_cut_btn");this.addCutBtn.bind("click",{widgetId:a},EMarkdownEditor.insertCut)};EMarkdownEditor.insertCut=(a)=>{a.preventDefault();(a=EMarkdownEditor.get(a.data.widgetId))&&a.textarea.insertAtCaret("\n___\n");return!1};
EMarkdownEditor.showUploadDialog=(a)=>{a.preventDefault();var b=a.data.widgetId,c=EMarkdownEditor.get(b);if(c.uploadLink.length){var d=jQuery("#uploadDialog");d.length?(EMarkdownEditor.initUploadDialog(b),d.modal("show")):jQuery.ajax({url:c.uploadLink,type:"GET",dataType:"json",success(b){jQuery(b.uploadDialog).appendTo(jQuery("body"));EMarkdownEditor.showUploadDialog(a)}})}};
EMarkdownEditor.initUploadDialog=(a)=>{var b=EMarkdownEditor.get(a),c=jQuery("#uploadDialog");c.find("#id_file").change(function(){if(this.files&&this.files[0]){var a=new FileReader;a.onload=(a)=>{var d=jQuery("#upload_image");d.on("load",(a)=>{var d=new Cropper(upload_image,{viewMode:1});c.find("#js-zoom-in").click(()=>{d.zoom(.1)});c.find("#js-zoom-out").click(()=>{d.zoom(-.1)});c.on("hidden.bs.modal",()=>{c.remove();d.destroy()});c.find("#js-crop-and-upload").click((a)=>{a.preventDefault();var e=
new FormData(c.find("#formUpload").get(0));e&&d.getCroppedCanvas().toBlob((a)=>{e.set("file",a,"photo.jpg");jQuery.ajax({url:b.uploadLink,type:"POST",data:e,cache:!1,processData:!1,contentType:!1,success(a){a.result&&(a="\n[!["+a.description+"]("+a.src+")]("+a.url+")\n",EMarkdownEditor.restoreSelection(),b.textarea.insertAtCaret(a),c.find("#upload-size-warning").addClass("d-none"),c.modal("hide"))},error(a,b,d){413===a.status&&c.find("#upload-size-warning").removeClass("d-none")}})});return!1});c.find("#upload-size-warning").addClass("d-none");
c.find("#cropBody").removeClass("d-none");c.find("#cropFooter").removeClass("d-none");c.find("#file_form_group").addClass("d-none")});d.attr("src",a.target.result)};a.readAsDataURL(this.files[0])}})};EMarkdownEditor.insertCode=(a)=>{a.preventDefault();if(a=EMarkdownEditor.get(a.data.widgetId)){var b=a.codeInput.val(),c=a.selectCode.val();if(0<b.length)return b="\n```"+c+"\n"+b+"\n```\n",EMarkdownEditor.restoreSelection(),a.textarea.insertAtCaret(b),a.codeInput.val(""),!0}return!1};
EMarkdownEditor.insertLink=(a)=>{a.preventDefault();if(a=EMarkdownEditor.get(a.data.widgetId)){var b=a.linkUrl.val();if(0<b.length){var c=a.linkText.val(),d=void 0,d=0<c.length?"["+c+"]("+b+")":"["+b+"]("+b+")";EMarkdownEditor.restoreSelection();a.textarea.insertAtCaret(d);a.linkUrl.val("");a.linkText.val("");return!0}}return!1};EMarkdownEditor.showDialog=(a)=>{a.data.dialog.modal("show");return!1};EMarkdownEditor.create=(a,b)=>{var c=new EMarkdownEditor(a,void 0===b?"":b);return allEditors[a]=c};
EMarkdownEditor.remove=(a)=>{delete allEditors[a]};EMarkdownEditor.get=(a)=>allEditors[a];EMarkdownEditor.saveSelection=()=>{if(window.getSelection){var a=window.getSelection();if(a.getRangeAt&&a.rangeCount)return a.getRangeAt(0)}else if(document.selection&&document.selection.createRange)return document.selection.createRange();return null};
EMarkdownEditor.restoreSelection=(a)=>{if(a)if(window.getSelection){var b=window.getSelection();b.removeAllRanges();b.addRange(a)}else document.selection&&a.select&&a.select()};EMarkdownEditor.updatePreview=(a)=>{var b=a.data.widgetId;$.ajax({url:"/evileg_core/markdown/",type:"POST",data:{content:jQuery("#"+b).val()},dataType:"json",success(a){jQuery("#"+b+"_preview").html(a.preview);prettyPrint()}})};
